<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>FaceTimey - Video Call</title>
    <style>
      * {
        margin: 0;
        padding: 0;
        box-sizing: border-box;
      }

      body {
        font-family: Arial, sans-serif;
        background-color: #f2f2f2;
        display: flex;
        justify-content: center;
        align-items: center;
        height: 100vh;
        overflow: hidden;
      }

      .container {
        width: 95%;
        max-width: 1200px;
        display: flex;
        flex-direction: column;
        align-items: center;
        background-color: white;
        border-radius: 8px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
      }

      h1 {
        margin-top: 20px;
        font-size: 24px;
        color: #333;
      }

      #videoContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        width: 100%;
        padding: 20px;
        margin-top: 20px;
        transition: all 0.3s ease-in-out;
      }

      video {
        width: 100%;
        border-radius: 8px;
        border: 1px solid #ddd;
        height: 200px;
        object-fit: cover;
      }

      .controls {
        display: flex;
        justify-content: center;
        margin: 20px 0;
        gap: 15px;
        flex-wrap: wrap;
      }

      button {
        padding: 12px 20px;
        font-size: 14px;
        color: #fff;
        background-color: #4caf50;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
      }

      button:hover {
        background-color: #45a049;
      }

      .controls button:disabled {
        background-color: #ccc;
        cursor: not-allowed;
      }

      .callStatus {
        margin-top: 10px;
        font-size: 16px;
        color: red;
        font-weight: bold;
      }

      #roomInfo {
        margin-top: 20px;
        text-align: center;
      }

      /* Full Screen */
      .video-wrapper {
        position: relative;
      }

      #fullscreenBtn {
        position: absolute;
        top: 10px;
        right: 10px;
        background-color: rgba(0, 0, 0, 0.5);
        color: white;
        padding: 5px;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        z-index: 10;
      }

      /* Chat UI */
      .chat-container {
        display: flex;
        flex-direction: column;
        width: 100%;
        margin-top: 20px;
      }

      .chat-messages {
        height: 200px;
        overflow-y: auto;
        padding: 10px;
        background-color: #f9f9f9;
        border: 1px solid #ddd;
        border-radius: 5px;
      }

      .chat-input-container {
        display: flex;
        margin-top: 10px;
      }

      .chat-input {
        width: 90%;
        padding: 10px;
        font-size: 16px;
        border: 1px solid #ddd;
        border-radius: 4px;
      }

      .chat-send-button {
        padding: 12px 20px;
        margin-left: 10px;
        background-color: #4caf50;
        color: #fff;
        border: none;
        border-radius: 4px;
        cursor: pointer;
      }

      .chat-send-button:hover {
        background-color: #45a049;
      }

      /* Position the full-screen icons inside the video box */
      .video-wrapper {
        position: relative;
      }

      .fullscreen-icon-container {
        position: absolute;
        top: 10px;
        right: 10px;
        display: flex;
        flex-direction: column;
        gap: 5px;
        z-index: 10;
      }

      .fullscreen-icon-container i {
        color: white;
        font-size: 24px;
        cursor: pointer;
        background-color: rgba(0, 0, 0, 0.5);
        border-radius: 50%;
        padding: 5px;
        transition: background-color 0.3s;
      }

      .fullscreen-icon-container i:hover {
        background-color: rgba(0, 0, 0, 0.8);
      }

      /* Optional: Change video container layout */
      #videoContainer {
        display: grid;
        grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
        gap: 20px;
        padding: 20px;
      }
    </style>
  </head>
  <body>
    <div class="container">
      <h1>FaceTimey - Simple Video Call</h1>

      <!-- Room Information -->
      <div id="roomInfo">
        <span>Room ID: <strong id="roomIdDisplay"></strong></span>
      </div>

      <!-- Video Container (for local and remote videos) -->
      <!-- Add Font Awesome for icons -->
      <link
        rel="stylesheet"
        href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
      />

      <div id="videoContainer" class="fullscreen-container">
        <!-- Local Video -->
        <div class="video-wrapper">
          <video id="localVideo" autoplay muted playsinline></video>
          <div class="fullscreen-icon-container">
            <i
              class="fas fa-expand"
              id="localFullscreenBtn"
              title="Go Full Screen"
            ></i>
            <i
              class="fas fa-compress"
              id="localExitFullscreenBtn"
              title="Exit Full Screen"
              style="display: none"
            ></i>
          </div>
        </div>
        <!-- Remote Video -->
        <div class="video-wrapper">
          <video id="remoteVideo" autoplay playsinline></video>
          <div class="fullscreen-icon-container">
            <i
              class="fas fa-expand"
              id="remoteFullscreenBtn"
              title="Go Full Screen"
            ></i>
            <i
              class="fas fa-compress"
              id="remoteExitFullscreenBtn"
              title="Exit Full Screen"
              style="display: none"
            ></i>
          </div>
        </div>
      </div>

      <!-- Controls Section -->
      <div class="controls">
        <button id="toggleVideo">Turn Camera Off</button>
        <button id="toggleAudio">Mute</button>
        <button id="shareScreen">Share Screen</button>
        <button id="disconnect">Leave Call</button>
      </div>

      <!-- Call Status -->
      <div class="callStatus" id="callStatus"></div>

      <!-- Chat Section -->
      <div class="chat-container">
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-container">
          <input
            type="text"
            id="chatInput"
            class="chat-input"
            placeholder="Type a message..."
          />
          <button class="chat-send-button" id="sendMessageButton">Send</button>
        </div>
      </div>
    </div>

    <script src="/socket.io/socket.io.js"></script>
    <script>
      const socket = io();

      const localVideo = document.getElementById("localVideo");
      const remoteVideo = document.getElementById("remoteVideo");
      const toggleVideoBtn = document.getElementById("toggleVideo");
      const toggleAudioBtn = document.getElementById("toggleAudio");
      const disconnectBtn = document.getElementById("disconnect");
      const shareScreenBtn = document.getElementById("shareScreen");
      const chatMessages = document.getElementById("chatMessages");
      const chatInput = document.getElementById("chatInput");
      const sendMessageButton = document.getElementById("sendMessageButton");
      const callStatus = document.getElementById("callStatus");
      const roomIdDisplay = document.getElementById("roomIdDisplay");
      const fullscreenBtn = document.getElementById("fullscreenBtn");
      const localFullscreenBtn = document.getElementById("localFullscreenBtn");
      const localExitFullscreenBtn = document.getElementById(
        "localExitFullscreenBtn"
      );
      const remoteFullscreenBtn = document.getElementById(
        "remoteFullscreenBtn"
      );
      const remoteExitFullscreenBtn = document.getElementById(
        "remoteExitFullscreenBtn"
      );

      let localStream;
      let peerConnection;
      let roomId;
      let screenStream;
      let isScreenSharing = false;
      let isFullScreen = false;
      let isLocalFullScreen = false;
      let isRemoteFullScreen = false;

      const configuration = {
        iceServers: [{ urls: "stun:stun.l.google.com:19302" }],
      };

      // Initialize media
      async function initMedia() {
        try {
          const constraints = {
            video: {
              width: { ideal: 1280 },
              height: { ideal: 720 },
            },
            audio: true,
          };

          localStream = await navigator.mediaDevices.getUserMedia(constraints);
          localVideo.srcObject = localStream;
        } catch (e) {
          alert("Could not get user media");
          console.error(e);
        }
      }

      initMedia();

      // Prompt user to enter room ID
      roomId = prompt("Enter room ID:");
      roomIdDisplay.textContent = roomId;

      socket.emit("join-room", roomId);

      socket.on("user-connected", (userId) => {
        callUser(userId);
      });

      socket.on("signal", async ({ id, signal }) => {
        if (!peerConnection) {
          createPeerConnection();
        }

        if (signal.type === "offer") {
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(signal)
          );
          const answer = await peerConnection.createAnswer();
          await peerConnection.setLocalDescription(answer);
          socket.emit("signal", peerConnection.localDescription);
        } else if (signal.type === "answer") {
          await peerConnection.setRemoteDescription(
            new RTCSessionDescription(signal)
          );
        } else if (signal.candidate) {
          try {
            await peerConnection.addIceCandidate(
              new RTCIceCandidate(signal.candidate)
            );
          } catch (e) {
            console.error("Error adding received ice candidate", e);
          }
        }
      });

      socket.on("user-disconnected", () => {
        endCall();
      });

      // Create peer connection
      function createPeerConnection() {
        peerConnection = new RTCPeerConnection(configuration);

        peerConnection.onicecandidate = (event) => {
          if (event.candidate) {
            socket.emit("signal", { candidate: event.candidate });
          }
        };

        peerConnection.ontrack = (event) => {
          remoteVideo.srcObject = event.streams[0];
        };

        const streamToAdd = isScreenSharing ? screenStream : localStream;
        streamToAdd.getTracks().forEach((track) => {
          peerConnection.addTrack(track, streamToAdd);
        });
      }

      // Handle fullscreen toggle for local video
      localFullscreenBtn.addEventListener("click", () => {
        if (isLocalFullScreen) {
          exitFullScreen(localVideo);
          isLocalFullScreen = false;
          localFullscreenBtn.style.display = "block";
          localExitFullscreenBtn.style.display = "none";
        } else {
          enterFullScreen(localVideo);
          isLocalFullScreen = true;
          localFullscreenBtn.style.display = "none";
          localExitFullscreenBtn.style.display = "block";
        }
      });

      // Handle fullscreen toggle for remote video
      remoteFullscreenBtn.addEventListener("click", () => {
        if (isRemoteFullScreen) {
          exitFullScreen(remoteVideo);
          isRemoteFullScreen = false;
          remoteFullscreenBtn.style.display = "block";
          remoteExitFullscreenBtn.style.display = "none";
        } else {
          enterFullScreen(remoteVideo);
          isRemoteFullScreen = true;
          remoteFullscreenBtn.style.display = "none";
          remoteExitFullscreenBtn.style.display = "block";
        }
      });

      // Function to request fullscreen for a video element
      function enterFullScreen(videoElement) {
        if (videoElement.requestFullscreen) {
          videoElement.requestFullscreen();
        } else if (videoElement.mozRequestFullScreen) {
          /* Firefox */
          videoElement.mozRequestFullScreen();
        } else if (videoElement.webkitRequestFullscreen) {
          /* Chrome, Safari & Opera */
          videoElement.webkitRequestFullscreen();
        } else if (videoElement.msRequestFullscreen) {
          /* IE/Edge */
          videoElement.msRequestFullscreen();
        }
      }

      // Function to exit fullscreen for a video element
      function exitFullScreen(videoElement) {
        if (document.exitFullscreen) {
          document.exitFullscreen();
        } else if (document.mozCancelFullScreen) {
          /* Firefox */
          document.mozCancelFullScreen();
        } else if (document.webkitExitFullscreen) {
          /* Chrome, Safari & Opera */
          document.webkitExitFullscreen();
        } else if (document.msExitFullscreen) {
          /* IE/Edge */
          document.msExitFullscreen();
        }
      }

      async function callUser(userId) {
        createPeerConnection();
        const offer = await peerConnection.createOffer();
        await peerConnection.setLocalDescription(offer);
        socket.emit("signal", peerConnection.localDescription);
      }

      // Toggle video
      toggleVideoBtn.onclick = () => {
        if (!localStream) return;
        const videoTrack = localStream.getVideoTracks()[0];
        if (videoTrack.enabled) {
          videoTrack.enabled = false;
          toggleVideoBtn.textContent = "Turn Camera On";
        } else {
          videoTrack.enabled = true;
          toggleVideoBtn.textContent = "Turn Camera Off";
        }
      };

      // Toggle audio
      toggleAudioBtn.onclick = () => {
        if (!localStream) return;
        const audioTrack = localStream.getAudioTracks()[0];
        if (audioTrack.enabled) {
          audioTrack.enabled = false;
          toggleAudioBtn.textContent = "Unmute";
        } else {
          audioTrack.enabled = true;
          toggleAudioBtn.textContent = "Mute";
        }
      };

      // Disconnect call
      disconnectBtn.onclick = () => {
        socket.emit("disconnect-call", roomId);
        endCall();
      };

      function endCall() {
        if (remoteVideo.srcObject) {
          remoteVideo.srcObject.getTracks().forEach((track) => track.stop());
        }
        remoteVideo.srcObject = null;

        if (peerConnection) {
          peerConnection.close();
          peerConnection = null;
        }

        if (localStream) {
          localStream.getTracks().forEach((track) => track.stop());
        }
        localVideo.srcObject = null;

        callStatus.textContent = "Call Disconnected";
        toggleAudioBtn.disabled = true;
        toggleVideoBtn.disabled = true;
        shareScreenBtn.disabled = true;
      }

      // Start/stop screen sharing
      shareScreenBtn.onclick = async () => {
        if (isScreenSharing) {
          stopScreenSharing();
        } else {
          startScreenSharing();
        }
      };

      async function startScreenSharing() {
        try {
          const isMobile = /iPhone|iPad|iPod|Android/i.test(
            navigator.userAgent
          );
          if (isMobile) {
            alert("Screen sharing is not supported on mobile browsers.");
            return;
          }

          screenStream = await navigator.mediaDevices.getDisplayMedia({
            video: true,
          });

          localVideo.srcObject = screenStream;
          isScreenSharing = true;
          shareScreenBtn.textContent = "Stop Sharing Screen";

          if (peerConnection) {
            peerConnection.getSenders().forEach((sender) => {
              if (sender.track.kind === "video") {
                sender.replaceTrack(screenStream.getVideoTracks()[0]);
              }
            });
          }
        } catch (err) {
          alert("Could not share screen");
          console.error("Error sharing screen:", err);
        }
      }

      function stopScreenSharing() {
        const tracks = screenStream.getTracks();
        tracks.forEach((track) => track.stop());
        localVideo.srcObject = localStream;
        isScreenSharing = false;
        shareScreenBtn.textContent = "Share Screen";

        if (peerConnection) {
          peerConnection.getSenders().forEach((sender) => {
            if (sender.track.kind === "video") {
              sender.replaceTrack(localStream.getVideoTracks()[0]);
            }
          });
        }
      }

      // Chat functionality (optional)
      sendMessageButton.onclick = () => {
        if (chatInput.value.trim()) {
          const message = chatInput.value;
          socket.emit("chat-message", { message, roomId });
          displayMessage("You: " + message);
          chatInput.value = "";
        }
      };

      socket.on("chat-message", (messageData) => {
        displayMessage(messageData.message);
      });

      function displayMessage(message) {
        const messageElement = document.createElement("div");
        messageElement.textContent = message;
        chatMessages.appendChild(messageElement);
      }
    </script>
  </body>
</html>
